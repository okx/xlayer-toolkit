FROM node:18-alpine AS builder

WORKDIR /build

# Install build dependencies
RUN apk add --no-cache python3 make g++

# Copy contract source from build context
COPY --from=contract . /build/contract

WORKDIR /build/contract

# ============================================================================
# Apply modifications using sed
# ============================================================================

# Modification 1: Add xlayer-devnet network to hardhat.config.ts
RUN sed -i '/etherscan: {/,/},/ { \
      /},/ a\
  networks: {\
    "xlayer-devnet": {\
      url: process.env.RPC_URL || "http://localhost:8123",\
      chainId: parseInt(process.env.CHAIN_ID || "195"),\
      accounts: process.env.DEPLOYER_PRIVATE_KEY ? [process.env.DEPLOYER_PRIVATE_KEY] : [],\
      gasPrice: 1000000000,\
    },\
  }, \
    }' hardhat.config.ts

# Modification 2: Add logVerify for PoseidonT3
RUN sed -i '/const poseidonT3 = await PoseidonT3\.deploy();/a\
  await logVerify('\''PoseidonT3'\'', poseidonT3, []);' \
    tasks/deploy/test.ts

# Modification 3: Add logVerify for PoseidonT4  
RUN sed -i '/const poseidonT4 = await PoseidonT4\.deploy();/a\
  await logVerify('\''PoseidonT4'\'', poseidonT4, []);' \
    tasks/deploy/test.ts

# Modification 4: Add poseidon addresses to deployment output
RUN sed -i '/implementation: implementation\.address,/a\
    poseidonT3: poseidonT3.address,\
    poseidonT4: poseidonT4.address,' \
    tasks/deploy/test.ts

# Verify modifications were applied
RUN echo "‚úÖ Checking modifications..." && \
    grep -q "xlayer-devnet" hardhat.config.ts && \
    echo "   ‚úì hardhat.config.ts modified" && \
    grep -q "logVerify.*PoseidonT3" tasks/deploy/test.ts && \
    echo "   ‚úì PoseidonT3 logVerify added" && \
    grep -q "logVerify.*PoseidonT4" tasks/deploy/test.ts && \
    echo "   ‚úì PoseidonT4 logVerify added" && \
    grep -q "poseidonT3: poseidonT3.address" tasks/deploy/test.ts && \
    echo "   ‚úì Poseidon addresses added to output" || \
    (echo "‚ùå Modifications failed" && exit 1)

# ============================================================================
# Install dependencies
# ============================================================================

RUN if [ -f yarn.lock ]; then \
      echo "üì¶ Installing with yarn..." && \
      yarn install --frozen-lockfile --network-timeout 300000; \
    else \
      echo "üì¶ Installing with npm..." && \
      npm install; \
    fi

# ============================================================================
# Runtime image
# ============================================================================
FROM node:18-alpine

WORKDIR /app

# Copy built contract with modifications
COPY --from=builder /build/contract /app

# Set default environment variables
ENV NETWORK=xlayer-devnet
ENV RPC_URL=http://host.docker.internal:8123
ENV CHAIN_ID=195

# Entrypoint: run hardhat deploy
ENTRYPOINT ["npx", "hardhat"]
CMD ["deploy:test", "--network", "xlayer-devnet"]

