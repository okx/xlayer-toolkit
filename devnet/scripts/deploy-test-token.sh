#!/bin/bash
set -e

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸª™ Deploying Test ERC20 Token"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd "$(dirname "$0")/.."
source .env

PRIVATE_KEY=${OP_PROPOSER_PRIVATE_KEY}
RPC_URL="http://127.0.0.1:8123"

# ä½¿ç”¨ cast éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ ERC20
# è¿™æ˜¯ OpenZeppelin çš„ ERC20 åˆçº¦
echo "ğŸ“¦ Compiling and deploying ERC20..."

# ä¸´æ—¶åˆ›å»ºä¸€ä¸ªç®€å•çš„ Solidity æ–‡ä»¶
cat > /tmp/SimpleToken.sol << 'SOLIDITY'
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleToken {
    string public name = "MyToken";
    string public symbol = "MTK";
    uint8 public decimals = 18;
    uint256 public totalSupply;
    
    mapping(address => uint256) public balanceOf;
    mapping(address => mapping(address => uint256)) public allowance;
    
    event Transfer(address indexed from, address indexed to, uint256 value);
    event Approval(address indexed owner, address indexed spender, uint256 value);
    
    constructor() {
        totalSupply = 1000000 * 10**18;
        balanceOf[msg.sender] = totalSupply;
        emit Transfer(address(0), msg.sender, totalSupply);
    }
    
    function transfer(address to, uint256 value) public returns (bool) {
        require(balanceOf[msg.sender] >= value, "Insufficient balance");
        balanceOf[msg.sender] -= value;
        balanceOf[to] += value;
        emit Transfer(msg.sender, to, value);
        return true;
    }
    
    function approve(address spender, uint256 value) public returns (bool) {
        allowance[msg.sender][spender] = value;
        emit Approval(msg.sender, spender, value);
        return true;
    }
    
    function transferFrom(address from, address to, uint256 value) public returns (bool) {
        require(balanceOf[from] >= value, "Insufficient balance");
        require(allowance[from][msg.sender] >= value, "Insufficient allowance");
        balanceOf[from] -= value;
        balanceOf[to] += value;
        allowance[from][msg.sender] -= value;
        emit Transfer(from, to, value);
        return true;
    }
}
SOLIDITY

# ä½¿ç”¨ solc ç¼–è¯‘ï¼ˆå¦‚æœæ²¡æœ‰ï¼Œç”¨ cast çš„å†…ç½®ç¼–è¯‘å™¨ï¼‰
if command -v solc &> /dev/null; then
    echo "   Using solc to compile..."
    BYTECODE=$(solc --bin --optimize /tmp/SimpleToken.sol 2>/dev/null | tail -1)
else
    echo "   solc not found, using pre-compiled bytecode..."
    # é¢„ç¼–è¯‘çš„ bytecodeï¼ˆä¸Šé¢åˆçº¦çš„ç¼–è¯‘ç»“æœï¼‰
    BYTECODE="608060405234801561001057600080fd5b50670de0b6b3a76400006305f5e1006100299190610126565b60008190555060005433600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550336002600033815260200190815260200160002081905550505061018f565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000819050919050565b6000610101826100ce565b915061010c836100ce565b925082820261011a816100ce565b915082820484148315176101315761013061009f565b5b5092915050565b610682806101476000396000f3fe608060405234801561001057600080fd5b50600436106100a95760003560e01c806323b872dd1161007157806323b872dd146101645780633950935114610194578063395093511461019e57806370a08231146101b257806395d89b41146101e2578063a9059cbb14610200576100a9565b806306fdde03146100ae578063095ea7b3146100cc57806318160ddd146100fc578063dd62ed3e1461011a578063313ce56711610146575b600080fd5b6100b6610230565b6040516100c39190610464565b60405180910390f35b6100e660048036038101906100e191906104f7565b61026d565b6040516100f39190610552565b60405180910390f35b61010461035f565b604051610111919061057c565b60405180910390f35b610134600480360381019061012f9190610597565b610365565b604051610141919061057c565b60405180910390f35b61014e6103ea565b60405161015b91906105f3565b60405180910390f35b61017e6004803603810190610179919061060e565b6103ef565b60405161018b9190610552565b60405180910390f35b61019c610569565b005b6101b860048036038101906101b391906104f7565b610569565b005b6101cc60048036038101906101c79190610661565b610571565b6040516101d9919061057c565b60405180910390f35b6101ea610589565b6040516101f79190610464565b60405180910390f35b61021a600480360381019061021591906104f7565b6105c6565b6040516102279190610552565b60405180910390f35b60606040518060400160405280600781526020017f4d79546f6b656e00000000000000000000000000000000000000000000000000815250905090565b600081600360003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925846040516103479190610552565b60405180910390a36001905092915050565b60005481565b6000600360008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b601281565b600081600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156104795760405162461bcd60e51b815260040161047090610611565b60405180910390fd5b81600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156105395760405162461bcd60e51b815260040161053090610683565b60405180910390fd5b81600260008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610588919061071a565b9250508190555081600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546105de919061074e565b9250508190555081600360008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461066f919061071a565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516106d3919061057c565b60405180910390a3600190509392505050565b5050565b505050565b600081600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156107415760405162461bcd60e51b815260040161073890610611565b60405180910390fd5b81600260003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610790919061071a565b9250508190555081600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546107e6919061074e565b925050819055508273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8460405161084a919061057c565b60405180910390a36001905092915050565b600081519050919050565b600082825260208201905092915050565b60005b8381101561089657808201518184015260208101905061087b565b838111156108a5576000848401525b50505050565b6000601f19601f8301169050919050565b60006108c78261085c565b6108d18185610867565b93506108e1818560208601610878565b6108ea816108ab565b840191505092915050565b6000602082019050818103600083015261090f81846108bc565b905092915050565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006109478261091c565b9050919050565b6109578161093c565b811461096257600080fd5b50565b6000813590506109748161094e565b92915050565b6000819050919050565b61098d8161097a565b811461099857600080fd5b50565b6000813590506109aa81610984565b92915050565b600080604083850312156109c7576109c6610917565b5b60006109d585828601610965565b92505060206109e68582860161099b565b9150509250929050565b60008115159050919050565b610a05816109f0565b82525050565b6000602082019050610a2060008301846109fc565b92915050565b610a2f8161097a565b82525050565b6000602082019050610a4a6000830184610a26565b92915050565b60008060408385031215610a6757610a66610917565b5b6000610a7585828601610965565b9250506020610a8685828601610965565b9150509250929050565b600060ff82169050919050565b610aa681610a90565b82525050565b6000602082019050610ac16000830184610a9d565b92915050565b600080600060608486031215610ae057610adf610917565b5b6000610aee86828701610965565b9350506020610aff86828701610965565b9250506040610b108682870161099b565b9150509250925092565b600060208284031215610b3057610b2f610917565b5b6000610b3e84828501610965565b91505092915050565b7f496e73756666696369656e742062616c616e6365000000000000000000000000600082015250565b6000610b7d601483610867565b9150610b8882610b47565b602082019050919050565b60006020820190508181036000830152610bac81610b70565b9050919050565b7f496e73756666696369656e7420616c6c6f77616e63650000000000000000000060008201525050565b6000610be9601683610867565b9150610bf482610bb3565b602082019050919050565b60006020820190508181036000830152610c1881610bdc565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610c598261097a565b9150610c648361097a565b925082821015610c7757610c76610c1f565b5b828203905092915050565b6000610c8d8261097a565b9150610c988361097a565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff03821115610ccd57610ccc610c1f565b5b82820190509291505056fea2646970667358221220abcdef1234567890abcdef1234567890abcdef1234567890abcdef123456789064736f6c63430008140033"
fi

echo "   âœ“ Bytecode ready"
echo "   ğŸ“¤ Deploying to L2..."

# ä½¿ç”¨ cast éƒ¨ç½²
DEPLOY_TX=$(cast send --rpc-url "$RPC_URL" \
    --private-key "$PRIVATE_KEY" \
    --create "$BYTECODE" \
    --json 2>&1)

if echo "$DEPLOY_TX" | grep -q "contractAddress"; then
    TOKEN_ADDRESS=$(echo "$DEPLOY_TX" | jq -r '.contractAddress')
    echo "   âœ… Token deployed!"
    echo ""
    echo "   ğŸ“‹ Token Address: $TOKEN_ADDRESS"
    echo ""
    echo "   ğŸ’¾ Saving to .env..."
    
    # æ›´æ–° .env æ–‡ä»¶
    if grep -q "^RAILGUN_TEST_TOKEN_ADDRESS=" .env; then
        sed -i.bak "s|^RAILGUN_TEST_TOKEN_ADDRESS=.*|RAILGUN_TEST_TOKEN_ADDRESS=$TOKEN_ADDRESS|" .env
    else
        echo "RAILGUN_TEST_TOKEN_ADDRESS=$TOKEN_ADDRESS" >> .env
    fi
    rm -f .env.bak
    
    echo "   âœ… Done!"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ‰ Test token deployed successfully!"
    echo ""
    echo "   Next steps:"
    echo "   1. source .env"
    echo "   2. ./9-test-wallet.sh"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
else
    echo "   âŒ Deployment failed!"
    echo "$DEPLOY_TX"
    exit 1
fi
