services:
  # L1 (Anvil) - local Ethereum node for testing
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil"]
    command:
      - --host
      - "0.0.0.0"
      - --port
      - "8545"
      - --chain-id
      - "31337"
      - --accounts
      - "10"
      - --balance
      - "10000"
      - --block-time
      - "1"
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - demo-network

  # L2 Node (block production and state management)
  node:
    build:
      context: .
      dockerfile: Dockerfile
      target: node
    ports:
      - "8546:8546"
    depends_on:
      anvil:
        condition: service_healthy
    networks:
      - demo-network

  # Batcher (submits block data to L1 BatchInbox)
  batcher:
    build:
      context: .
      dockerfile: Dockerfile
      target: batcher
    env_file:
      - .env
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Proposer (submits outputs and generates ZK proofs)
  proposer:
    build:
      context: .
      dockerfile: Dockerfile
      target: proposer
    env_file:
      - .env
    environment:
      # SP1 prover settings (NETWORK_PRIVATE_KEY is what sp1-sdk expects)
      - SP1_PROVER=${SP1_PROVER:-mock}
      - SP1_PRIVATE_KEY=${SP1_PRIVATE_KEY:-}
      - NETWORK_PRIVATE_KEY=${SP1_PRIVATE_KEY:-}
      - ELF_PATH=${ELF_PATH:-}
    volumes:
      # Mount ELF directory for SP1 mode
      - ./elf:/app/elf:ro
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Challenger (monitors outputs and initiates disputes)
  challenger:
    build:
      context: .
      dockerfile: Dockerfile
      target: challenger
    env_file:
      - .env
    environment:
      # SP1 prover settings (NETWORK_PRIVATE_KEY is what sp1-sdk expects)
      - SP1_PROVER=${SP1_PROVER:-mock}
      - SP1_PRIVATE_KEY=${SP1_PRIVATE_KEY:-}
      - NETWORK_PRIVATE_KEY=${SP1_PRIVATE_KEY:-}
      - ELF_PATH=${ELF_PATH:-}
    volumes:
      # Mount ELF directory for SP1 mode
      - ./elf:/app/elf:ro
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Benchmarker (sends transactions to node for load testing)
  benchmarker:
    build:
      context: .
      dockerfile: Dockerfile
      target: benchmarker
    environment:
      - NODE_RPC=http://node:8546
      - BENCHMARK_TPS=${BENCHMARK_TPS:-100}
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

networks:
  demo-network:
    driver: bridge
