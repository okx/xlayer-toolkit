services:
  # L1 (Anvil) - 和 demo 保持一致
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    entrypoint: ["anvil"]
    command:
      - --host
      - "0.0.0.0"
      - --port
      - "8545"
      - --chain-id
      - "31337"
      - --accounts
      - "10"
      - --balance
      - "10000"
      - --block-time
      - "1"
    ports:
      - "8545:8545"
    healthcheck:
      test: ["CMD", "cast", "block-number", "--rpc-url", "http://localhost:8545"]
      interval: 2s
      timeout: 5s
      retries: 10
    networks:
      - demo-network

  # L2 Node (Mock for demo)
  node:
    build:
      context: .
      dockerfile: Dockerfile
      target: node
    ports:
      - "8546:8546"
    depends_on:
      anvil:
        condition: service_healthy
    networks:
      - demo-network

  # Batcher (submits block data to L1 BatchInbox)
  batcher:
    build:
      context: .
      dockerfile: Dockerfile
      target: batcher
    env_file:
      - .env
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Proposer
  proposer:
    build:
      context: .
      dockerfile: Dockerfile
      target: proposer
    env_file:
      - .env
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Challenger
  challenger:
    build:
      context: .
      dockerfile: Dockerfile
      target: challenger
    env_file:
      - .env
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

  # Benchmarker (sends transactions to node)
  benchmarker:
    build:
      context: .
      dockerfile: Dockerfile
      target: benchmarker
    environment:
      - NODE_RPC=http://node:8546
      - BENCHMARK_TPS=${BENCHMARK_TPS:-100}
    depends_on:
      - node
    restart: unless-stopped
    networks:
      - demo-network

networks:
  demo-network:
    driver: bridge
