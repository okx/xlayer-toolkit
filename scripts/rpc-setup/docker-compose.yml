version: '3.8'

networks:
  xlayer-network:
    name: xlayer-network

services:
  op-geth:
    image: "${OP_GETH_IMAGE_TAG}"
    container_name: xlayer-op-geth
    entrypoint: geth
    ports:
      - "8545:8545"   # HTTP RPC
      - "8552:8552"
      - "7546:7546"
      - "30303:30303" # P2P TCP
      - "30303:30303/udp" # P2P UDP
    volumes:
      - ./data:/data
      - ./config/jwt.txt:/jwt.txt
      - ./config/op-geth-config-testnet.toml:/config.toml
      - ./logs/op-geth:/var/log/op-geth
    command:
      - --verbosity=3
      - --datadir=/data
      - --config=/config.toml
      - --db.engine=pebble
      - --gcmode=archive
      - --rollup.enabletxpooladmission
      - --rollup.sequencerhttp=https://testrpc.xlayer.tech
      - --log.file=/var/log/op-geth/geth.log
    networks:
      - xlayer-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8545"]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 3s

  op-node:
    image: "${OP_STACK_IMAGE_TAG}"
    container_name: xlayer-op-node
    entrypoint: sh
    networks:
      - xlayer-network
    ports:
      - "9545:9545"
    volumes:
      - ./data/op-node:/data
      - ./config/rollup.json:/rollup.json
      - ./config/jwt.txt:/jwt.txt
      - ./logs/op-node:/var/log/op-node
    command:
      - -c
      - |
        exec /app/op-node/bin/op-node \
          --log.level=info \
          --l2=http://op-geth:8552 \
          --l2.jwt-secret=/jwt.txt \
          --sequencer.enabled=false \
          --verifier.l1-confs=1 \
          --rollup.config=/rollup.json \
          --rpc.addr=0.0.0.0 \
          --rpc.port=9545 \
          --p2p.listen.tcp=9223 \
          --p2p.listen.udp=9223 \
          --p2p.peerstore.path=/data/p2p/opnode_peerstore_db \
          --p2p.discovery.path=/data/p2p/opnode_discovery_db \
          --p2p.bootnodes=enode://eaae9fe2fc758add65fe4cfd42918e898e16ab23294db88f0dcdbcab2773e75bbea6bfdaa42b3ed502dfbee1335c242c602078c4aa009264e4705caa20d3dca7@8.210.181.50:9223 \
          --p2p.static=/ip4/47.242.219.101/tcp/9223/p2p/16Uiu2HAkwUdbn9Q7UBKQYRsfjm9SQX5Yc2e96HUz2pyR3cw1FZLv,/ip4/47.242.235.15/tcp/9223/p2p/16Uiu2HAmThDG9xMpADbyGo1oCU8fndztwNg1PH6A7yp1BhCk5jfE \
          --rpc.enable-admin=true \
          --l1=${L1_RPC_URL} \
          --l1.beacon=${L1_BEACON_URL} \
          --l1.rpckind=standard \
          --conductor.enabled=false \
          --safedb.path=/data/safedb \
          2>&1 | tee /var/log/op-node/op-node.log
    depends_on:
      - op-geth
