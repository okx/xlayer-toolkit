networks:
  xlayer-network:
    name: xlayer-network

services:
  op-geth:
    image: "${OP_GETH_IMAGE_TAG}"
    container_name: xlayer-op-geth
    entrypoint: geth
    ports:
      - "${HTTP_RPC_PORT:-8123}:8545"   # HTTP RPC
      - "${ENGINE_API_PORT:-8552}:8552"
      - "${WEBSOCKET_PORT:-7546}:7546"
      - "${P2P_TCP_PORT:-30303}:30303" # P2P TCP
      - "${P2P_UDP_PORT:-30303}:30303/udp" # P2P UDP
    volumes:
      - ./data/op-geth:/data
      - ./config/jwt.txt:/jwt.txt
      - ./config/op-geth-config-testnet.toml:/config.toml
    command:
      - --verbosity=3
      - --datadir=/data
      - --config=/config.toml
      - --db.engine=pebble
      - --gcmode=archive
      - --rollup.enabletxpooladmission
      - --rollup.sequencerhttp=https://testrpc.xlayer.tech
    networks:
      - xlayer-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:8545"]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 3s

  op-reth:
    image: "${OP_RETH_IMAGE_TAG:-op-reth:latest}"
    container_name: xlayer-op-reth
    networks:
      - xlayer-network
    entrypoint: /entrypoint/reth-rpc.sh
    env_file:
      - .env
    volumes:
      - ./data/op-reth:/datadir
      - ./config/jwt.txt:/jwt.txt
      - ./config/genesis-reth.json:/genesis.json
      - ./config/op-reth-config-testnet.toml:/config.toml
      - ./entrypoint/reth-rpc.sh:/entrypoint/reth-rpc.sh
      - ./.env:/app/.env
    ports:
      - "${HTTP_RPC_PORT:-8123}:8545"
      - "${WEBSOCKET_PORT:-7546}:7546"
      - "${ENGINE_API_PORT:-8552}:8552"
      - "${P2P_TCP_PORT:-30303}:30303"
      - "${P2P_UDP_PORT:-30303}:30303/udp"
    healthcheck:
      test: ["CMD", "curl", "-X", "POST", "http://localhost:8545"]
      interval: 3s
      timeout: 3s
      retries: 10
      start_period: 3s

  op-node:
    image: "${OP_STACK_IMAGE_TAG}"
    container_name: xlayer-op-node
    networks:
      - xlayer-network
    ports:
      - "${NODE_RPC_PORT:-9545}:9545"
    volumes:
      - ./data/op-node:/data
      - ./config/rollup.json:/rollup.json
      - ./config/jwt.txt:/jwt.txt
    command:
      - /app/op-node/bin/op-node
      - --log.level=info
      - --l2=http://${RPC_TYPE:-op-geth}:8552
      - --l2.jwt-secret=/jwt.txt
      - --sequencer.enabled=false
      - --verifier.l1-confs=1
      - --rollup.config=/rollup.json
      - --rpc.addr=0.0.0.0
      - --rpc.port=9545
      - --p2p.listen.tcp=9223
      - --p2p.listen.udp=9223
      - --p2p.peerstore.path=/data/p2p/opnode_peerstore_db
      - --p2p.discovery.path=/data/p2p/opnode_discovery_db
      - --p2p.bootnodes=${OP_NODE_BOOTNODE}
      - --rpc.enable-admin=true
      - --l1=${L1_RPC_URL}
      # - --l1.beacon.ignore=true
      - --l1.beacon=${L1_BEACON_URL}
      - --l1.rpckind=standard
      - --conductor.enabled=false
      - --safedb.path=/data/safedb
      - --l2.enginekind=${L2_ENGINEKIND:-geth}
    depends_on:
      - ${RPC_TYPE:-op-geth}
